@using DynamicPermissionSystem.Models
@{
    var roles = ViewBag.Roles as List<Role> ?? new List<Role>();
    var menus = ViewBag.Menus as List<Menu> ?? new List<Menu>();
    var perms = ViewBag.Perms as List<RoleMenuPermission> ?? new List<RoleMenuPermission>();
    var selectedRoleId = ViewBag.SelectedRoleId as int? ?? 0;
}

<div class=" mt-4">
    <h3 class="mb-4 text-primary fw-bold">🔐 Manage Role Permissions</h3>

    <!-- ✅ Auto reload on role change -->
<form method="get" action="/Admin/ManagePermissions" id="roleForm">
    <div class="mb-3">
        <label class="form-label fw-semibold">Select Role</label>
        <select name="roleId" class="form-select w-auto d-inline-block" onchange="this.form.submit()">
            @foreach (var r in roles)
            {
                <option value="@r.Id" >@r.Name</option>
            }
        </select>
    </div>
</form>




    <!-- ✅ Permission Save Form -->
    <form method="post" asp-action="SavePermissions">
        <input type="hidden" name="roleId" value="@selectedRoleId" />

        <table class="table table-bordered align-middle">
            <thead class="table-light text-center">
                <tr>
                    <th>Menu</th>
                    <th>View</th>
                    <th>Create</th>
                    <th>Edit</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var m in menus)
                {
                    var row = perms.FirstOrDefault(p => p.MenuId == m.Id);
                    <tr>
                        <td>@m.Name</td>
                        <td class="text-center">
                            <input type="checkbox" name="flags" value="view_@m.Id" @(row?.CanView == true ? "checked" : "") />
                        </td>
                        <td class="text-center">
                            <input type="checkbox" name="flags" value="create_@m.Id" @(row?.CanCreate == true ? "checked" : "") />
                        </td>
                        <td class="text-center">
                            <input type="checkbox" name="flags" value="edit_@m.Id" @(row?.CanEdit == true ? "checked" : "") />
                        </td>
                        <td class="text-center">
                            <input type="checkbox" name="flags" value="delete_@m.Id" @(row?.CanDelete == true ? "checked" : "") />
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="text-end">
            <button type="submit" class="btn btn-primary px-4">💾 Save Permissions</button>
        </div>
    </form>
</div>
