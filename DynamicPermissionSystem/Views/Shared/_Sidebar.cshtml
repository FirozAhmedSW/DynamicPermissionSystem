@using Microsoft.EntityFrameworkCore
@inject DynamicPermissionSystem.Models.ApplicationDbContext Db
@{
    var roleId = Context.Session.GetInt32("RoleId") ?? 0;

    // ✅ Include Menu to avoid null
    var permissions = Db.RoleMenuPermissions.Include(rp => rp.Menu).Where(rp => rp.RoleId == roleId && rp.CanView).ToList();
    // ✅ Flatten menu list
    var menus = permissions.Select(rp => rp.Menu).ToList();
    // ✅ Group submenus
    var menuGroups = menus.GroupBy(m => m.ParentId).ToDictionary(g => g.Key, g => g.ToList());
}

<ul class="nav flex-column mt-3">
    @if (menuGroups.ContainsKey(null))
    {
        foreach (var menu in menuGroups[null])
        {
            <li class="nav-item">
                <a class="nav-link text-dark fw-semibold" asp-controller="@menu.Controller" asp-action="@menu.Action">
                    @menu.Name
                </a>

                @if (menuGroups.ContainsKey(menu.Id))
                {
                    <ul class="nav flex-column ms-3">
                        @foreach (var sub in menuGroups[menu.Id])
                        {
                            <li class="nav-item">
                                <a class="nav-link text-secondary" asp-controller="@sub.Controller" asp-action="@sub.Action">
                                    @sub.Name
                                </a>
                            </li>
                        }
                    </ul>
                }
            </li>
        }
    }
</ul>
